From 94cd83a284ae34d39eac217f5f91e07450d75cee Mon Sep 17 00:00:00 2001
From: David Eddlemon <DavidEddlemon@Hotmail.com>
Date: Mon, 19 Aug 2013 23:23:05 +0400
Subject: [PATCH] Strict Aliasing Violations CCCCCCCCCOMBO BREAKER!

---
 camera/Android.mk                                  |  2 ++
 cmds/stagefright/Android.mk                        | 16 +++++-----
 cmds/stagefright/SineSource.h                      |  6 +++-
 drm/common/Android.mk                              |  2 ++
 drm/drmserver/Android.mk                           |  2 ++
 drm/libdrmframework/Android.mk                     |  2 ++
 drm/mediadrm/plugins/mock/Android.mk               |  2 ++
 include/media/ToneGenerator.h                      | 18 +++++++----
 libvideoeditor/Android.mk                          |  2 ++
 libvideoeditor/lvpp/Android.mk                     |  3 +-
 libvideoeditor/osal/Android.mk                     |  2 ++
 libvideoeditor/osal/src/Android.mk                 |  3 +-
 libvideoeditor/vss/3gpwriter/Android.mk            |  2 ++
 libvideoeditor/vss/3gpwriter/src/Android.mk        |  3 +-
 libvideoeditor/vss/Android.mk                      |  4 ++-
 libvideoeditor/vss/mcs/Android.mk                  |  2 ++
 libvideoeditor/vss/mcs/src/Android.mk              |  3 +-
 libvideoeditor/vss/src/Android.mk                  |  3 +-
 libvideoeditor/vss/stagefrightshells/Android.mk    |  2 ++
 .../vss/stagefrightshells/src/Android.mk           |  2 +-
 libvideoeditor/vss/video_filters/Android.mk        |  2 ++
 libvideoeditor/vss/video_filters/src/Android.mk    |  2 +-
 media/common_time/Android.mk                       |  2 ++
 media/libeffects/downmix/Android.mk                |  2 +-
 media/libeffects/downmix/EffectDownmix.c           |  8 +++--
 media/libeffects/factory/Android.mk                |  2 ++
 media/libeffects/lvm/lib/Android.mk                |  4 +--
 media/libeffects/lvm/wrapper/Android.mk            |  4 +--
 media/libeffects/preprocessing/Android.mk          |  2 +-
 media/libeffects/testlibs/Android.mk_              |  4 +--
 media/libeffects/visualizer/Android.mk             |  2 +-
 media/libeffects/visualizer/EffectVisualizer.cpp   | 24 ++++++++++----
 media/libmedia/Android.mk                          | 10 +++---
 media/libmedia/Visualizer.cpp                      | 37 ++++++++++++++--------
 media/libmediaplayerservice/Android.mk             | 20 +++++++++---
 media/libmediaplayerservice/MediaPlayerFactory.cpp |  7 ++--
 media/libnbaio/Android.mk                          |  2 ++
 media/libstagefright/Android.mk                    | 16 +++++-----
 media/libstagefright/OMXCodec.cpp                  |  6 ++--
 media/mediaserver/Android.mk                       |  2 +-
 media/mtp/Android.mk                               |  2 +-
 services/audioflinger/Android.mk                   | 14 ++++----
 services/audioflinger/AudioResampler.h             | 10 ++++--
 services/camera/libcameraservice/Android.mk        | 10 +++++-
 services/medialog/Android.mk                       |  2 ++
 tools/resampler_tools/Android.mk                   |  2 +-
 46 files changed, 186 insertions(+), 93 deletions(-)

diff --git a/camera/Android.mk b/camera/Android.mk
index 3ebb43c..640900c 100644
--- a/camera/Android.mk
+++ b/camera/Android.mk
@@ -42,4 +42,6 @@ endif
 
 LOCAL_MODULE:= libcamera_client
 
+LOCAL_CFLAGS += -fno-strict-aliasing
+
 include $(BUILD_SHARED_LIBRARY)
diff --git a/cmds/stagefright/Android.mk b/cmds/stagefright/Android.mk
index 3844487..bc4f29e 100644
--- a/cmds/stagefright/Android.mk
+++ b/cmds/stagefright/Android.mk
@@ -17,7 +17,7 @@ LOCAL_C_INCLUDES:= \
 	$(TOP)/frameworks/native/include/media/openmax \
 	external/jpeg \
 
-LOCAL_CFLAGS += -Wno-multichar
+LOCAL_CFLAGS += -Wno-multichar -fno-strict-aliasing
 
 LOCAL_MODULE_TAGS := debug
 
@@ -40,7 +40,7 @@ LOCAL_C_INCLUDES:= \
 	frameworks/av/media/libstagefright \
 	$(TOP)/frameworks/native/include/media/openmax
 
-LOCAL_CFLAGS += -Wno-multichar
+LOCAL_CFLAGS += -Wno-multichar -fno-strict-aliasing
 
 LOCAL_MODULE_TAGS := debug
 
@@ -63,7 +63,7 @@ LOCAL_C_INCLUDES:= \
 	frameworks/av/media/libstagefright \
 	$(TOP)/frameworks/native/include/media/openmax
 
-LOCAL_CFLAGS += -Wno-multichar
+LOCAL_CFLAGS += -Wno-multichar -fno-strict-aliasing
 
 LOCAL_MODULE_TAGS := debug
 
@@ -87,7 +87,7 @@ LOCAL_C_INCLUDES:= \
 	frameworks/av/media/libstagefright \
 	$(TOP)/frameworks/native/include/media/openmax
 
-LOCAL_CFLAGS += -Wno-multichar
+LOCAL_CFLAGS += -Wno-multichar -fno-strict-aliasing
 
 LOCAL_MODULE_TAGS := debug
 
@@ -110,7 +110,7 @@ LOCAL_C_INCLUDES:= \
 	frameworks/av/media/libstagefright \
 	$(TOP)/frameworks/native/include/media/openmax
 
-LOCAL_CFLAGS += -Wno-multichar
+LOCAL_CFLAGS += -Wno-multichar -fno-strict-aliasing
 
 LOCAL_MODULE_TAGS := debug
 
@@ -133,7 +133,7 @@ LOCAL_C_INCLUDES:= \
 	frameworks/av/media/libstagefright \
 	$(TOP)/frameworks/native/include/media/openmax
 
-LOCAL_CFLAGS += -Wno-multichar
+LOCAL_CFLAGS += -Wno-multichar -fno-strict-aliasing
 
 LOCAL_MODULE_TAGS := debug
 
@@ -157,7 +157,7 @@ LOCAL_C_INCLUDES:= \
 	frameworks/av/media/libstagefright \
 	$(TOP)/frameworks/native/include/media/openmax
 
-LOCAL_CFLAGS += -Wno-multichar
+LOCAL_CFLAGS += -Wno-multichar -fno-strict-aliasing
 
 LOCAL_MODULE_TAGS := debug
 
@@ -180,7 +180,7 @@ LOCAL_C_INCLUDES:= \
 	frameworks/av/media/libstagefright \
 	$(TOP)/frameworks/native/include/media/openmax
 
-LOCAL_CFLAGS += -Wno-multichar
+LOCAL_CFLAGS += -Wno-multichar -fno-strict-aliasing
 
 LOCAL_MODULE_TAGS := debug
 
diff --git a/cmds/stagefright/SineSource.h b/cmds/stagefright/SineSource.h
index 76ab669..41d3bf3 100644
--- a/cmds/stagefright/SineSource.h
+++ b/cmds/stagefright/SineSource.h
@@ -4,6 +4,10 @@
 
 #include <media/stagefright/MediaSource.h>
 
+#if __cplusplus < 201103L && !defined(__GXX_EXPERIMENTAL_CXX0X__) && !defined(constexpr)
+#define constexpr const
+#endif
+
 namespace android {
 
 struct MediaBufferGroup;
@@ -24,7 +28,7 @@ struct SineSource : public MediaSource {
 
 private:
     enum { kBufferSize = 8192 };
-    static const double kFrequency = 500.0;
+    static constexpr double kFrequency = 500.0;
 
     bool mStarted;
     int32_t mSampleRate;
diff --git a/drm/common/Android.mk b/drm/common/Android.mk
index db67534..5fa7dbb 100644
--- a/drm/common/Android.mk
+++ b/drm/common/Android.mk
@@ -40,4 +40,6 @@ LOCAL_MODULE:= libdrmframeworkcommon
 
 LOCAL_MODULE_TAGS := optional
 
+LOCAL_CFLAGS += -fno-strict-aliasing
+
 include $(BUILD_STATIC_LIBRARY)
diff --git a/drm/drmserver/Android.mk b/drm/drmserver/Android.mk
index dc973da..c80773e 100644
--- a/drm/drmserver/Android.mk
+++ b/drm/drmserver/Android.mk
@@ -39,4 +39,6 @@ LOCAL_MODULE:= drmserver
 
 LOCAL_MODULE_TAGS := optional
 
+LOCAL_CFLAGS += -fno-strict-aliasing
+
 include $(BUILD_EXECUTABLE)
diff --git a/drm/libdrmframework/Android.mk b/drm/libdrmframework/Android.mk
index 49c4f9b..4b6586d 100644
--- a/drm/libdrmframework/Android.mk
+++ b/drm/libdrmframework/Android.mk
@@ -40,6 +40,8 @@ LOCAL_C_INCLUDES += \
 
 LOCAL_MODULE_TAGS := optional
 
+LOCAL_CFLAGS += -fno-strict-aliasing
+
 include $(BUILD_SHARED_LIBRARY)
 
 include $(call all-makefiles-under,$(LOCAL_PATH))
diff --git a/drm/mediadrm/plugins/mock/Android.mk b/drm/mediadrm/plugins/mock/Android.mk
index ada23a2..94f185f 100644
--- a/drm/mediadrm/plugins/mock/Android.mk
+++ b/drm/mediadrm/plugins/mock/Android.mk
@@ -35,4 +35,6 @@ LOCAL_C_INCLUDES += \
 
 LOCAL_MODULE_TAGS := optional
 
+LOCAL_CFLAGS += -fno-strict-aliasing
+
 include $(BUILD_SHARED_LIBRARY)
diff --git a/include/media/ToneGenerator.h b/include/media/ToneGenerator.h
index 23e4235..ee4c266 100644
--- a/include/media/ToneGenerator.h
+++ b/include/media/ToneGenerator.h
@@ -23,6 +23,10 @@
 #include <media/AudioSystem.h>
 #include <media/AudioTrack.h>
 
+#if __cplusplus < 201103L && !defined(__GXX_EXPERIMENTAL_CXX0X__) && !defined(constexpr)
+#define constexpr const
+#endif
+
 namespace android {
 
 class ToneGenerator {
@@ -208,10 +212,10 @@ class ToneGenerator {
 
     static const unsigned char sToneMappingTable[NUM_REGIONS-1][NUM_SUP_TONES];
 
-    static const unsigned int TONEGEN_MAX_WAVES = 3;     // Maximun number of sine waves in a tone segment
-    static const unsigned int TONEGEN_MAX_SEGMENTS = 12;  // Maximun number of segments in a tone descriptor
-    static const unsigned int TONEGEN_INF = 0xFFFFFFFF;  // Represents infinite time duration
-    static const float TONEGEN_GAIN = 0.9;  // Default gain passed to  WaveGenerator().
+    static constexpr unsigned int TONEGEN_MAX_WAVES = 3;     // Maximun number of sine waves in a tone segment
+    static constexpr unsigned int TONEGEN_MAX_SEGMENTS = 12;  // Maximun number of segments in a tone descriptor
+    static constexpr unsigned int TONEGEN_INF = 0xFFFFFFFF;  // Represents infinite time duration
+    static constexpr float TONEGEN_GAIN = 0.9;  // Default gain passed to  WaveGenerator().
 
     // ToneDescriptor class contains all parameters needed to generate a tone:
     //    - The array waveFreq[]:
@@ -301,9 +305,9 @@ class ToneGenerator {
                 unsigned int command);
 
     private:
-        static const short GEN_AMP = 32000;  // amplitude of generator
-        static const short S_Q14 = 14;  // shift for Q14
-        static const short S_Q15 = 15;  // shift for Q15
+        static constexpr short GEN_AMP = 32000;  // amplitude of generator
+        static constexpr short S_Q14 = 14;  // shift for Q14
+        static constexpr short S_Q15 = 15;  // shift for Q15
 
         short mA1_Q14;  // Q14 coefficient
         // delay line of full amplitude generator
diff --git a/libvideoeditor/Android.mk b/libvideoeditor/Android.mk
index 5053e7d..ecc7e07 100755
--- a/libvideoeditor/Android.mk
+++ b/libvideoeditor/Android.mk
@@ -1 +1,3 @@
 include $(call all-subdir-makefiles)
+
+LOCAL_CFLAGS += -fno-strict-aliasing
diff --git a/libvideoeditor/lvpp/Android.mk b/libvideoeditor/lvpp/Android.mk
index 2286827..1185d85 100755
--- a/libvideoeditor/lvpp/Android.mk
+++ b/libvideoeditor/lvpp/Android.mk
@@ -98,7 +98,8 @@ LOCAL_CFLAGS += -Wno-multichar \
     -DUSE_STAGEFRIGHT_AUDIOENC \
     -DUSE_STAGEFRIGHT_VIDEOENC \
     -DUSE_STAGEFRIGHT_READERS \
-    -DUSE_STAGEFRIGHT_3GPP_READER
+    -DUSE_STAGEFRIGHT_3GPP_READER \
+    -fno-strict-aliasing
 
 include $(BUILD_SHARED_LIBRARY)
 
diff --git a/libvideoeditor/osal/Android.mk b/libvideoeditor/osal/Android.mk
index 5053e7d..ecc7e07 100755
--- a/libvideoeditor/osal/Android.mk
+++ b/libvideoeditor/osal/Android.mk
@@ -1 +1,3 @@
 include $(call all-subdir-makefiles)
+
+LOCAL_CFLAGS += -fno-strict-aliasing
diff --git a/libvideoeditor/osal/src/Android.mk b/libvideoeditor/osal/src/Android.mk
index 4f38b0c..aabe930 100755
--- a/libvideoeditor/osal/src/Android.mk
+++ b/libvideoeditor/osal/src/Android.mk
@@ -61,6 +61,7 @@ LOCAL_CFLAGS += -Wno-multichar \
     -DUSE_STAGEFRIGHT_AUDIOENC \
     -DUSE_STAGEFRIGHT_VIDEOENC \
     -DUSE_STAGEFRIGHT_READERS \
-    -DUSE_STAGEFRIGHT_3GPP_READER
+    -DUSE_STAGEFRIGHT_3GPP_READER \
+    -fno-strict-aliasing
 
 include $(BUILD_SHARED_LIBRARY)
diff --git a/libvideoeditor/vss/3gpwriter/Android.mk b/libvideoeditor/vss/3gpwriter/Android.mk
index 5053e7d..ecc7e07 100755
--- a/libvideoeditor/vss/3gpwriter/Android.mk
+++ b/libvideoeditor/vss/3gpwriter/Android.mk
@@ -1 +1,3 @@
 include $(call all-subdir-makefiles)
+
+LOCAL_CFLAGS += -fno-strict-aliasing
diff --git a/libvideoeditor/vss/3gpwriter/src/Android.mk b/libvideoeditor/vss/3gpwriter/src/Android.mk
index 8ab32ba..ca255fa 100755
--- a/libvideoeditor/vss/3gpwriter/src/Android.mk
+++ b/libvideoeditor/vss/3gpwriter/src/Android.mk
@@ -48,7 +48,8 @@ LOCAL_LDLIBS := \
     -lpthread -ldl
 
 LOCAL_CFLAGS += -Wno-multichar \
-    -DDUPLICATE_STTS_IN_LAST_AU
+    -DDUPLICATE_STTS_IN_LAST_AU \
+    -fno-strict-aliasing
 
 include $(BUILD_STATIC_LIBRARY)
 
diff --git a/libvideoeditor/vss/Android.mk b/libvideoeditor/vss/Android.mk
index 1d4ec7f..ecc7e07 100755
--- a/libvideoeditor/vss/Android.mk
+++ b/libvideoeditor/vss/Android.mk
@@ -1 +1,3 @@
-include $(call all-subdir-makefiles)
\ No newline at end of file
+include $(call all-subdir-makefiles)
+
+LOCAL_CFLAGS += -fno-strict-aliasing
diff --git a/libvideoeditor/vss/mcs/Android.mk b/libvideoeditor/vss/mcs/Android.mk
index 5053e7d..ecc7e07 100755
--- a/libvideoeditor/vss/mcs/Android.mk
+++ b/libvideoeditor/vss/mcs/Android.mk
@@ -1 +1,3 @@
 include $(call all-subdir-makefiles)
+
+LOCAL_CFLAGS += -fno-strict-aliasing
diff --git a/libvideoeditor/vss/mcs/src/Android.mk b/libvideoeditor/vss/mcs/src/Android.mk
index b470e6b..fbb4606 100755
--- a/libvideoeditor/vss/mcs/src/Android.mk
+++ b/libvideoeditor/vss/mcs/src/Android.mk
@@ -52,7 +52,8 @@ LOCAL_LDLIBS := \
     -lpthread -ldl
 
 LOCAL_CFLAGS += -Wno-multichar \
-    -DM4MCS_WITH_FAST_OPEN
+    -DM4MCS_WITH_FAST_OPEN \
+    -fno-strict-aliasing
 
 include $(BUILD_STATIC_LIBRARY)
 
diff --git a/libvideoeditor/vss/src/Android.mk b/libvideoeditor/vss/src/Android.mk
index 0caa15b..f6a7493 100755
--- a/libvideoeditor/vss/src/Android.mk
+++ b/libvideoeditor/vss/src/Android.mk
@@ -94,6 +94,7 @@ LOCAL_LDLIBS := \
 
 LOCAL_CFLAGS += -Wno-multichar \
     -DM4xVSS_RESERVED_MOOV_DISK_SPACEno \
-    -DDECODE_GIF_ON_SAVING
+    -DDECODE_GIF_ON_SAVING \
+    -fno-strict-aliasing
 
 include $(BUILD_SHARED_LIBRARY)
diff --git a/libvideoeditor/vss/stagefrightshells/Android.mk b/libvideoeditor/vss/stagefrightshells/Android.mk
index 5053e7d..ecc7e07 100755
--- a/libvideoeditor/vss/stagefrightshells/Android.mk
+++ b/libvideoeditor/vss/stagefrightshells/Android.mk
@@ -1 +1,3 @@
 include $(call all-subdir-makefiles)
+
+LOCAL_CFLAGS += -fno-strict-aliasing
diff --git a/libvideoeditor/vss/stagefrightshells/src/Android.mk b/libvideoeditor/vss/stagefrightshells/src/Android.mk
index e30b85d..946ac01 100755
--- a/libvideoeditor/vss/stagefrightshells/src/Android.mk
+++ b/libvideoeditor/vss/stagefrightshells/src/Android.mk
@@ -55,7 +55,7 @@ LOCAL_SHARED_LIBRARIES :=     \
     libvideoeditor_osal       \
     libvideoeditorplayer      \
 
-LOCAL_CFLAGS += \
+LOCAL_CFLAGS += -fno-strict-aliasing \
 
 LOCAL_STATIC_LIBRARIES := \
     libstagefright_color_conversion
diff --git a/libvideoeditor/vss/video_filters/Android.mk b/libvideoeditor/vss/video_filters/Android.mk
index e2d2111..60d58a3 100755
--- a/libvideoeditor/vss/video_filters/Android.mk
+++ b/libvideoeditor/vss/video_filters/Android.mk
@@ -3,3 +3,5 @@
 
 #include $(call all-makefiles-under,$(LOCAL_PATH))
 include $(call all-subdir-makefiles)
+
+LOCAL_CFLAGS += -fno-strict-aliasing
diff --git a/libvideoeditor/vss/video_filters/src/Android.mk b/libvideoeditor/vss/video_filters/src/Android.mk
index 85a530c..1486d24 100755
--- a/libvideoeditor/vss/video_filters/src/Android.mk
+++ b/libvideoeditor/vss/video_filters/src/Android.mk
@@ -51,7 +51,7 @@ LOCAL_SHARED_LIBRARIES += libdl
 LOCAL_LDLIBS := \
     -lpthread -ldl
 
-LOCAL_CFLAGS += -Wno-multichar
+LOCAL_CFLAGS += -Wno-multichar -fno-strict-aliasing
 
 include $(BUILD_SHARED_LIBRARY)
 
diff --git a/media/common_time/Android.mk b/media/common_time/Android.mk
index 632acbc..57dec99 100644
--- a/media/common_time/Android.mk
+++ b/media/common_time/Android.mk
@@ -7,6 +7,8 @@ LOCAL_PATH:= $(call my-dir)
 
 include $(CLEAR_VARS)
 
+LOCAL_CFLAGS += -fno-strict-aliasing
+
 LOCAL_MODULE := libcommon_time_client
 LOCAL_MODULE_TAGS := optional
 LOCAL_SRC_FILES := cc_helper.cpp \
diff --git a/media/libeffects/downmix/Android.mk b/media/libeffects/downmix/Android.mk
index 5d0a87c..72b5b48 100644
--- a/media/libeffects/downmix/Android.mk
+++ b/media/libeffects/downmix/Android.mk
@@ -25,6 +25,6 @@ LOCAL_C_INCLUDES := \
 
 LOCAL_PRELINK_MODULE := false
 
-LOCAL_CFLAGS += -fvisibility=hidden
+LOCAL_CFLAGS += -fvisibility=hidden -fno-strict-aliasing
 
 include $(BUILD_SHARED_LIBRARY)
diff --git a/media/libeffects/downmix/EffectDownmix.c b/media/libeffects/downmix/EffectDownmix.c
index f17a6e8..d477cb0 100644
--- a/media/libeffects/downmix/EffectDownmix.c
+++ b/media/libeffects/downmix/EffectDownmix.c
@@ -415,7 +415,8 @@ static int Downmix_Command(effect_handle_t self, uint32_t cmdCode, uint32_t cmdS
         memcpy(pReplyData, pCmdData, sizeof(effect_param_t) + sizeof(int32_t));
         ALOGV("Downmix_Command EFFECT_CMD_GET_PARAM param %d, replySize %d",
                 *(int32_t *)rep->data, rep->vsize);
-        rep->status = Downmix_getParameter(pDownmixer, *(int32_t *)rep->data, &rep->vsize,
+	int32_t rep_data; memcpy(&rep_data, rep->data, sizeof(int32_t));
+        rep->status = Downmix_getParameter(pDownmixer, rep_data /* *(int32_t *)rep->data */, &rep->vsize,
                 rep->data + sizeof(int32_t));
         *replySize = sizeof(effect_param_t) + sizeof(int32_t) + rep->vsize;
         break;
@@ -428,7 +429,8 @@ static int Downmix_Command(effect_handle_t self, uint32_t cmdCode, uint32_t cmdS
             return -EINVAL;
         }
         effect_param_t *cmd = (effect_param_t *) pCmdData;
-        *(int *)pReplyData = Downmix_setParameter(pDownmixer, *(int32_t *)cmd->data,
+	int32_t cmd_data; memcpy(&cmd_data, cmd->data, sizeof(int32_t));
+        *(int *)pReplyData = Downmix_setParameter(pDownmixer, cmd_data /* *(int32_t *)cmd->data*/,
                 cmd->vsize, cmd->data + sizeof(int32_t));
         break;
 
@@ -629,7 +631,7 @@ int Downmix_Configure(downmix_module_t *pDwmModule, effect_config_t *pConfig, bo
         return -EINVAL;
     }
 
-    memcpy(&pDwmModule->config, pConfig, sizeof(effect_config_t));
+    memmove(&pDwmModule->config, pConfig, sizeof(effect_config_t));
 
     if (init) {
         pDownmixer->type = DOWNMIX_TYPE_FOLD;
diff --git a/media/libeffects/factory/Android.mk b/media/libeffects/factory/Android.mk
index 60a6ce5..16a7841 100644
--- a/media/libeffects/factory/Android.mk
+++ b/media/libeffects/factory/Android.mk
@@ -17,4 +17,6 @@ LOCAL_SHARED_LIBRARIES += libdl
 LOCAL_C_INCLUDES := \
     $(call include-path-for, audio-effects)
 
+LOCAL_CFLAGS += -fno-strict-aliasing
+
 include $(BUILD_SHARED_LIBRARY)
diff --git a/media/libeffects/lvm/lib/Android.mk b/media/libeffects/lvm/lib/Android.mk
index bb56c75..e6e8be6 100644
--- a/media/libeffects/lvm/lib/Android.mk
+++ b/media/libeffects/lvm/lib/Android.mk
@@ -119,7 +119,7 @@ LOCAL_C_INCLUDES += \
     $(LOCAL_PATH)/StereoWidening/src \
     $(LOCAL_PATH)/StereoWidening/lib
 
-LOCAL_CFLAGS += -fvisibility=hidden
+LOCAL_CFLAGS += -fvisibility=hidden -fno-strict-aliasing
 
 include $(BUILD_STATIC_LIBRARY)
 
@@ -176,5 +176,5 @@ LOCAL_C_INCLUDES += \
     $(LOCAL_PATH)/Common/lib \
     $(LOCAL_PATH)/Common/src
 
-LOCAL_CFLAGS += -fvisibility=hidden
+LOCAL_CFLAGS += -fvisibility=hidden -fno-strict-aliasing
 include $(BUILD_STATIC_LIBRARY)
diff --git a/media/libeffects/lvm/wrapper/Android.mk b/media/libeffects/lvm/wrapper/Android.mk
index f1af389..75a918e 100644
--- a/media/libeffects/lvm/wrapper/Android.mk
+++ b/media/libeffects/lvm/wrapper/Android.mk
@@ -9,7 +9,7 @@ LOCAL_ARM_MODE := arm
 LOCAL_SRC_FILES:= \
 	Bundle/EffectBundle.cpp
 
-LOCAL_CFLAGS += -fvisibility=hidden
+LOCAL_CFLAGS += -fvisibility=hidden -fno-strict-aliasing
 
 LOCAL_MODULE:= libbundlewrapper
 
@@ -38,7 +38,7 @@ LOCAL_ARM_MODE := arm
 LOCAL_SRC_FILES:= \
     Reverb/EffectReverb.cpp
 
-LOCAL_CFLAGS += -fvisibility=hidden
+LOCAL_CFLAGS += -fvisibility=hidden -fno-strict-aliasing
 
 LOCAL_MODULE:= libreverbwrapper
 
diff --git a/media/libeffects/preprocessing/Android.mk b/media/libeffects/preprocessing/Android.mk
index c344352..95abc7e 100644
--- a/media/libeffects/preprocessing/Android.mk
+++ b/media/libeffects/preprocessing/Android.mk
@@ -30,6 +30,6 @@ else
 LOCAL_SHARED_LIBRARIES += libdl
 endif
 
-LOCAL_CFLAGS += -fvisibility=hidden
+LOCAL_CFLAGS += -fvisibility=hidden -fno-strict-aliasing
 
 include $(BUILD_SHARED_LIBRARY)
diff --git a/media/libeffects/testlibs/Android.mk_ b/media/libeffects/testlibs/Android.mk_
index 2954908..3df5919 100644
--- a/media/libeffects/testlibs/Android.mk_
+++ b/media/libeffects/testlibs/Android.mk_
@@ -6,7 +6,7 @@ include $(CLEAR_VARS)
 LOCAL_SRC_FILES:= \
 	EffectReverb.c.arm \
 	EffectsMath.c.arm
-LOCAL_CFLAGS+= -O2
+LOCAL_CFLAGS+= -O2 -fno-strict-aliasing
 
 LOCAL_SHARED_LIBRARIES := \
 	libcutils
@@ -42,7 +42,7 @@ LOCAL_SRC_FILES:= \
 	AudioShelvingFilter.cpp.arm \
 	AudioEqualizer.cpp.arm
 
-LOCAL_CFLAGS+= -O2
+LOCAL_CFLAGS+= -O2 -fno-strict-aliasing
 
 LOCAL_SHARED_LIBRARIES := \
 	libcutils
diff --git a/media/libeffects/visualizer/Android.mk b/media/libeffects/visualizer/Android.mk
index e196eb2..35d7ec9 100644
--- a/media/libeffects/visualizer/Android.mk
+++ b/media/libeffects/visualizer/Android.mk
@@ -6,7 +6,7 @@ include $(CLEAR_VARS)
 LOCAL_SRC_FILES:= \
 	EffectVisualizer.cpp
 
-LOCAL_CFLAGS+= -O2 -fvisibility=hidden
+LOCAL_CFLAGS+= -O2 -fvisibility=hidden -fno-strict-aliasing
 
 LOCAL_SHARED_LIBRARIES := \
 	libcutils \
diff --git a/media/libeffects/visualizer/EffectVisualizer.cpp b/media/libeffects/visualizer/EffectVisualizer.cpp
index e7eccf1..37d523b 100644
--- a/media/libeffects/visualizer/EffectVisualizer.cpp
+++ b/media/libeffects/visualizer/EffectVisualizer.cpp
@@ -404,22 +404,27 @@ int Visualizer_command(effect_handle_t self, uint32_t cmdCode, uint32_t cmdSize,
         }
         memcpy(pReplyData, pCmdData, sizeof(effect_param_t) + sizeof(uint32_t));
         effect_param_t *p = (effect_param_t *)pReplyData;
+	union {
+            char *data;
+            uint32_t *data32;
+        };
+        data = p->data;
         p->status = 0;
         *replySize = sizeof(effect_param_t) + sizeof(uint32_t);
         if (p->psize != sizeof(uint32_t)) {
             p->status = -EINVAL;
             break;
         }
-        switch (*(uint32_t *)p->data) {
+        switch (data32[0]) {
         case VISUALIZER_PARAM_CAPTURE_SIZE:
             ALOGV("get mCaptureSize = %d", pContext->mCaptureSize);
-            *((uint32_t *)p->data + 1) = pContext->mCaptureSize;
+            data[1] = pContext->mCaptureSize;
             p->vsize = sizeof(uint32_t);
             *replySize += sizeof(uint32_t);
             break;
         case VISUALIZER_PARAM_SCALING_MODE:
             ALOGV("get mScalingMode = %d", pContext->mScalingMode);
-            *((uint32_t *)p->data + 1) = pContext->mScalingMode;
+            data[1] = pContext->mScalingMode;
             p->vsize = sizeof(uint32_t);
             *replySize += sizeof(uint32_t);
             break;
@@ -435,21 +440,26 @@ int Visualizer_command(effect_handle_t self, uint32_t cmdCode, uint32_t cmdSize,
         }
         *(int32_t *)pReplyData = 0;
         effect_param_t *p = (effect_param_t *)pCmdData;
+	union {
+            char *data;
+            uint32_t *data32;
+        };
+        data = p->data;
         if (p->psize != sizeof(uint32_t) || p->vsize != sizeof(uint32_t)) {
             *(int32_t *)pReplyData = -EINVAL;
             break;
         }
-        switch (*(uint32_t *)p->data) {
+        switch (data32[0]) {
         case VISUALIZER_PARAM_CAPTURE_SIZE:
-            pContext->mCaptureSize = *((uint32_t *)p->data + 1);
+            pContext->mCaptureSize = data[1];
             ALOGV("set mCaptureSize = %d", pContext->mCaptureSize);
             break;
         case VISUALIZER_PARAM_SCALING_MODE:
-            pContext->mScalingMode = *((uint32_t *)p->data + 1);
+            pContext->mScalingMode = data[1];
             ALOGV("set mScalingMode = %d", pContext->mScalingMode);
             break;
         case VISUALIZER_PARAM_LATENCY:
-            pContext->mLatency = *((uint32_t *)p->data + 1);
+            pContext->mLatency = data[1];
             ALOGV("set mLatency = %d", pContext->mLatency);
             break;
         default:
diff --git a/media/libmedia/Android.mk b/media/libmedia/Android.mk
index 7fc23aa..9dd2f43 100644
--- a/media/libmedia/Android.mk
+++ b/media/libmedia/Android.mk
@@ -72,7 +72,7 @@ LOCAL_SRC_FILES+= \
 endif
 
 ifeq ($(BOARD_USE_SAMSUNG_SEPARATEDSTREAM),true)
-LOCAL_CFLAGS += -DUSE_SAMSUNG_SEPARATEDSTREAM
+LOCAL_CFLAGS += -DUSE_SAMSUNG_SEPARATEDSTREAM -fno-strict-aliasing
 endif
 
 ifeq ($(BOARD_USES_QCOM_HARDWARE),true)
@@ -82,19 +82,19 @@ LOCAL_SRC_FILES += \
 
 ifeq ($(TARGET_QCOM_AUDIO_VARIANT),caf)
 ifeq ($(BOARD_USES_ALSA_AUDIO),true)
-    LOCAL_CFLAGS += -DQCOM_VOIP_ENABLED
+    LOCAL_CFLAGS += -DQCOM_VOIP_ENABLED -fno-strict-aliasing
 else
 ifeq ($(BOARD_QCOM_VOIP_ENABLED),true)
-    LOCAL_CFLAGS += -DQCOM_VOIP_ENABLED
+    LOCAL_CFLAGS += -DQCOM_VOIP_ENABLED -fno-strict-aliasing
 endif
 endif
 endif
 endif
 
 # for <cutils/atomic-inline.h>
-LOCAL_CFLAGS += -DANDROID_SMP=$(if $(findstring true,$(TARGET_CPU_SMP)),1,0)
+LOCAL_CFLAGS += -DANDROID_SMP=$(if $(findstring true,$(TARGET_CPU_SMP)),1,0) -fno-strict-aliasing
 LOCAL_SRC_FILES += SingleStateQueue.cpp
-LOCAL_CFLAGS += -DSINGLE_STATE_QUEUE_INSTANTIATIONS='"SingleStateQueueInstantiations.cpp"'
+LOCAL_CFLAGS += -DSINGLE_STATE_QUEUE_INSTANTIATIONS='"SingleStateQueueInstantiations.cpp"' -fno-strict-aliasing
 
 LOCAL_SHARED_LIBRARIES := \
 	libui liblog libcutils libutils libbinder libsonivox libicuuc libexpat \
diff --git a/media/libmedia/Visualizer.cpp b/media/libmedia/Visualizer.cpp
index 5b4071b..0758c7b 100644
--- a/media/libmedia/Visualizer.cpp
+++ b/media/libmedia/Visualizer.cpp
@@ -135,13 +135,17 @@ status_t Visualizer::setCaptureSize(uint32_t size)
         return INVALID_OPERATION;
     }
 
-    uint32_t buf32[sizeof(effect_param_t) / sizeof(uint32_t) + 2];
-    effect_param_t *p = (effect_param_t *)buf32;
+    union {
+        uint32_t buf32[sizeof(effect_param_t) / sizeof(uint32_t) + 2];
+        effect_param_t bufp;
+    };
+    effect_param_t *p = &bufp;
 
     p->psize = sizeof(uint32_t);
     p->vsize = sizeof(uint32_t);
-    *(int32_t *)p->data = VISUALIZER_PARAM_CAPTURE_SIZE;
-    *((int32_t *)p->data + 1)= size;
+    int32_t const vpcs = VISUALIZER_PARAM_CAPTURE_SIZE;
+    memcpy(&p->data, &vpcs, sizeof(vpcs));
+    memcpy(&p->data+sizeof(int32_t), &size, sizeof(size));
     status_t status = setParameter(p);
 
     ALOGV("setCaptureSize size %d  status %d p->status %d", size, status, p->status);
@@ -169,8 +173,10 @@ status_t Visualizer::setScalingMode(uint32_t mode) {
 
     p->psize = sizeof(uint32_t);
     p->vsize = sizeof(uint32_t);
-    *(int32_t *)p->data = VISUALIZER_PARAM_SCALING_MODE;
-    *((int32_t *)p->data + 1)= mode;
+
+    int32_t const vpsm = VISUALIZER_PARAM_SCALING_MODE;
+    memcpy(&p->data, &vpsm, sizeof(vpsm));
+    memcpy(&p->data+sizeof(int32_t), &mode, sizeof(mode));
     status_t status = setParameter(p);
 
     ALOGV("setScalingMode mode %d  status %d p->status %d", mode, status, p->status);
@@ -297,21 +303,24 @@ void Visualizer::periodicCapture()
 
 uint32_t Visualizer::initCaptureSize()
 {
-    uint32_t buf32[sizeof(effect_param_t) / sizeof(uint32_t) + 2];
-    effect_param_t *p = (effect_param_t *)buf32;
+    union {
+        uint32_t buf32[sizeof(effect_param_t) / sizeof(uint32_t) + 2];
+        effect_param_t p;
+    };
 
-    p->psize = sizeof(uint32_t);
-    p->vsize = sizeof(uint32_t);
-    *(int32_t *)p->data = VISUALIZER_PARAM_CAPTURE_SIZE;
-    status_t status = getParameter(p);
+    p.psize = sizeof(uint32_t);
+    p.vsize = sizeof(uint32_t);
+    int32_t const vpcs = VISUALIZER_PARAM_CAPTURE_SIZE;
+    memcpy(&p.data, &vpcs, sizeof(vpcs));
+    status_t status = getParameter(&p);
 
     if (status == NO_ERROR) {
-        status = p->status;
+        status = p.status;
     }
 
     uint32_t size = 0;
     if (status == NO_ERROR) {
-        size = *((int32_t *)p->data + 1);
+        memcpy(&size, &p.data+sizeof(int32_t), sizeof(int32_t));
     }
     mCaptureSize = size;
 
diff --git a/media/libmediaplayerservice/Android.mk b/media/libmediaplayerservice/Android.mk
index 679d65a..7986479 100644
--- a/media/libmediaplayerservice/Android.mk
+++ b/media/libmediaplayerservice/Android.mk
@@ -58,22 +58,32 @@ ifeq ($(BOARD_USES_QCOM_HARDWARE),true)
     LOCAL_C_INCLUDES += \
             $(TOP)/hardware/qcom/media-caf/mm-core/inc
     else
-    LOCAL_C_INCLUDES += \
-            $(TOP)/hardware/qcom/media/mm-core/inc
+        ifeq ($(TARGET_QCOM_DISPLAY_VARIANT),legacy)
+            LOCAL_C_INCLUDES += \
+                $(TOP)/hardware/qcom/media-legacy/mm-core/inc
+        else
+            LOCAL_C_INCLUDES += \
+                $(TOP)/hardware/qcom/media/mm-core/inc
+        endif
     endif
 endif
 
 LOCAL_MODULE:= libmediaplayerservice
 
 ifeq ($(TARGET_ENABLE_QC_AV_ENHANCEMENTS),true)
-    LOCAL_CFLAGS += -DENABLE_QC_AV_ENHANCEMENTS
+    LOCAL_CFLAGS += -DENABLE_QC_AV_ENHANCEMENTS -fno-strict-aliasing
     LOCAL_C_INCLUDES += $(TOP)/frameworks/av/include/media
     ifeq ($(TARGET_QCOM_MEDIA_VARIANT),caf)
         LOCAL_C_INCLUDES += \
             $(TOP)/hardware/qcom/media-caf/mm-core/inc
     else
-        LOCAL_C_INCLUDES += \
-            $(TOP)/hardware/qcom/media/mm-core/inc
+        ifeq ($(TARGET_QCOM_DISPLAY_VARIANT),legacy)
+            LOCAL_C_INCLUDES += \
+                $(TOP)/hardware/qcom/media-legacy/mm-core/inc
+        else
+            LOCAL_C_INCLUDES += \
+                $(TOP)/hardware/qcom/media/mm-core/inc
+        endif
     endif
 endif #TARGET_ENABLE_QC_AV_ENHANCEMENTS
 
diff --git a/media/libmediaplayerservice/MediaPlayerFactory.cpp b/media/libmediaplayerservice/MediaPlayerFactory.cpp
index 80f1a9a..cbc7811 100644
--- a/media/libmediaplayerservice/MediaPlayerFactory.cpp
+++ b/media/libmediaplayerservice/MediaPlayerFactory.cpp
@@ -176,12 +176,15 @@ class StagefrightPlayerFactory :
                                int64_t offset,
                                int64_t length,
                                float curScore) {
-        char buf[20];
+        union {
+            char buf[20];
+            long bufl[20/sizeof(long)];
+        };
         lseek(fd, offset, SEEK_SET);
         read(fd, buf, sizeof(buf));
         lseek(fd, offset, SEEK_SET);
 
-        long ident = *((long*)buf);
+        const long ident = bufl[0];
 
         // Ogg vorbis?
         if (ident == 0x5367674f) // 'OggS'
diff --git a/media/libnbaio/Android.mk b/media/libnbaio/Android.mk
index 5d00d15..87aba11 100644
--- a/media/libnbaio/Android.mk
+++ b/media/libnbaio/Android.mk
@@ -33,4 +33,6 @@ LOCAL_SHARED_LIBRARIES := \
     libutils \
     liblog
 
+LOCAL_CFLAGS += -fno-strict-aliasing
+
 include $(BUILD_SHARED_LIBRARY)
diff --git a/media/libstagefright/Android.mk b/media/libstagefright/Android.mk
index 09b723b..bedd61e 100644
--- a/media/libstagefright/Android.mk
+++ b/media/libstagefright/Android.mk
@@ -88,17 +88,17 @@ ifeq ($(TARGET_QCOM_AUDIO_VARIANT),caf)
         LOCAL_SRC_FILES += LPAPlayerALSA.cpp
         ifeq ($(call is-chipset-in-board-platform,msm8960),true)
             LOCAL_SRC_FILES += TunnelPlayer.cpp
-            LOCAL_CFLAGS += -DUSE_TUNNEL_MODE
+            LOCAL_CFLAGS += -DUSE_TUNNEL_MODE -fno-strict-aliasing
             LOCAL_CFLAGS += -DTUNNEL_MODE_SUPPORTS_AMRWB
         endif
         ifeq ($(NO_TUNNEL_MODE_FOR_MULTICHANNEL),true)
-            LOCAL_CFLAGS += -DNO_TUNNEL_MODE_FOR_MULTICHANNEL
+            LOCAL_CFLAGS += -DNO_TUNNEL_MODE_FOR_MULTICHANNEL -fno-strict-aliasing
         endif
     else
         LOCAL_SRC_FILES += LPAPlayer.cpp
-        LOCAL_CFLAGS += -DLEGACY_LPA
+        LOCAL_CFLAGS += -DLEGACY_LPA -fno-strict-aliasing
     endif
-    LOCAL_CFLAGS += -DQCOM_ENHANCED_AUDIO
+    LOCAL_CFLAGS += -DQCOM_ENHANCED_AUDIO -fno-strict-aliasing
 endif
 
 ifeq ($(TARGET_QCOM_MEDIA_VARIANT),caf)
@@ -158,10 +158,10 @@ LOCAL_SHARED_LIBRARIES += \
         libstagefright_foundation \
         libdl
 
-LOCAL_CFLAGS += -Wno-multichar
+LOCAL_CFLAGS += -Wno-multichar -fno-strict-aliasing
 
 ifeq ($(BOARD_USE_SAMSUNG_COLORFORMAT), true)
-LOCAL_CFLAGS += -DUSE_SAMSUNG_COLORFORMAT
+LOCAL_CFLAGS += -DUSE_SAMSUNG_COLORFORMAT -fno-strict-aliasing
 
 # Include native color format header path
 LOCAL_C_INCLUDES += \
@@ -171,7 +171,7 @@ LOCAL_C_INCLUDES += \
 endif
 
 ifeq ($(BOARD_USE_TI_DUCATI_H264_PROFILE), true)
-LOCAL_CFLAGS += -DUSE_TI_DUCATI_H264_PROFILE
+LOCAL_CFLAGS += -DUSE_TI_DUCATI_H264_PROFILE -fno-strict-aliasing
 endif
 
 LOCAL_MODULE:= libstagefright
@@ -180,7 +180,7 @@ LOCAL_MODULE_TAGS := optional
 
 
 ifeq ($(TARGET_ENABLE_QC_AV_ENHANCEMENTS),true)
-    LOCAL_CFLAGS += -DENABLE_QC_AV_ENHANCEMENTS
+    LOCAL_CFLAGS += -DENABLE_QC_AV_ENHANCEMENTS -fno-strict-aliasing
     LOCAL_SRC_FILES  += ExtendedWriter.cpp
     LOCAL_SRC_FILES  += QCMediaDefs.cpp
     ifeq ($(TARGET_QCOM_MEDIA_VARIANT),caf)
diff --git a/media/libstagefright/OMXCodec.cpp b/media/libstagefright/OMXCodec.cpp
index 172f687..3cd8ec8 100644
--- a/media/libstagefright/OMXCodec.cpp
+++ b/media/libstagefright/OMXCodec.cpp
@@ -150,9 +150,9 @@ static int calc_plane(int width, int height)
 #undef FACTORY_REF
 #undef FACTORY_CREATE
 
-#define CODEC_LOGI(x, ...) ALOGI("[%s] "x, mComponentName, ##__VA_ARGS__)
-#define CODEC_LOGV(x, ...) ALOGV("[%s] "x, mComponentName, ##__VA_ARGS__)
-#define CODEC_LOGE(x, ...) ALOGE("[%s] "x, mComponentName, ##__VA_ARGS__)
+#define CODEC_LOGI(x, ...) ALOGI("[%s] " x, mComponentName, ##__VA_ARGS__)
+#define CODEC_LOGV(x, ...) ALOGV("[%s] " x, mComponentName, ##__VA_ARGS__)
+#define CODEC_LOGE(x, ...) ALOGE("[%s] " x, mComponentName, ##__VA_ARGS__)
 
 struct OMXCodecObserver : public BnOMXObserver {
     OMXCodecObserver() {
diff --git a/media/mediaserver/Android.mk b/media/mediaserver/Android.mk
index be48cb2..2a2a545 100644
--- a/media/mediaserver/Android.mk
+++ b/media/mediaserver/Android.mk
@@ -11,7 +11,7 @@ endif
 include $(CLEAR_VARS)
 
 ifeq ($(QCOM_LISTEN_FEATURE),true)
-  LOCAL_CFLAGS += -DQCOM_LISTEN_FEATURE_ENABLE
+  LOCAL_CFLAGS += -DQCOM_LISTEN_FEATURE_ENABLE -fno-strict-aliasing
 endif
 
 LOCAL_SRC_FILES:= \
diff --git a/media/mtp/Android.mk b/media/mtp/Android.mk
index ac608a1..82170b0 100644
--- a/media/mtp/Android.mk
+++ b/media/mtp/Android.mk
@@ -37,7 +37,7 @@ LOCAL_SRC_FILES:=                                       \
 
 LOCAL_MODULE:= libmtp
 
-LOCAL_CFLAGS := -DMTP_DEVICE -DMTP_HOST
+LOCAL_CFLAGS := -DMTP_DEVICE -DMTP_HOST -fno-strict-aliasing
 
 # Needed for <bionic_time.h>
 LOCAL_C_INCLUDES := bionic/libc/private
diff --git a/services/audioflinger/Android.mk b/services/audioflinger/Android.mk
index 7fc9872..ce77dec 100644
--- a/services/audioflinger/Android.mk
+++ b/services/audioflinger/Android.mk
@@ -28,7 +28,7 @@ LOCAL_SRC_FILES:=               \
 LOCAL_SRC_FILES += StateQueue.cpp
 
 # uncomment for debugging timing problems related to StateQueue::push()
-LOCAL_CFLAGS += -DSTATE_QUEUE_DUMP
+LOCAL_CFLAGS += -DSTATE_QUEUE_DUMP -fno-strict-aliasing
 
 LOCAL_C_INCLUDES := \
     $(call include-path-for, audio-effects) \
@@ -52,7 +52,7 @@ LOCAL_SHARED_LIBRARIES := \
 # SRS Processing
 ifeq ($(strip $(BOARD_USES_SRS_TRUEMEDIA)),true)
 LOCAL_SHARED_LIBRARIES += libsrsprocessing
-LOCAL_CFLAGS += -DSRS_PROCESSING
+LOCAL_CFLAGS += -DSRS_PROCESSING -fon-strict-aliasing
 LOCAL_C_INCLUDES += $(TARGET_OUT_HEADERS)/mm-audio/audio-effects
 endif
 # SRS Processing
@@ -66,14 +66,14 @@ LOCAL_MODULE:= libaudioflinger
 
 LOCAL_SRC_FILES += FastMixer.cpp FastMixerState.cpp
 
-LOCAL_CFLAGS += -DFAST_MIXER_STATISTICS
+LOCAL_CFLAGS += -DFAST_MIXER_STATISTICS -fno-strict-aliasing
 
 # uncomment to display CPU load adjusted for CPU frequency
 # LOCAL_CFLAGS += -DCPU_FREQUENCY_STATISTICS
 
 LOCAL_CFLAGS += -DSTATE_QUEUE_INSTANTIATIONS='"StateQueueInstantiations.cpp"'
 
-LOCAL_CFLAGS += -UFAST_TRACKS_AT_NON_NATIVE_SAMPLE_RATE
+LOCAL_CFLAGS += -UFAST_TRACKS_AT_NON_NATIVE_SAMPLE_RATE -fno-strict-aliasing
 
 # uncomment to allow tee sink debugging to be enabled by property
 # LOCAL_CFLAGS += -DTEE_SINK
@@ -84,9 +84,9 @@ LOCAL_CFLAGS += -UFAST_TRACKS_AT_NON_NATIVE_SAMPLE_RATE
 
 # Define ANDROID_SMP appropriately. Used to get inline tracing fast-path.
 ifeq ($(TARGET_CPU_SMP),true)
-    LOCAL_CFLAGS += -DANDROID_SMP=1
+    LOCAL_CFLAGS += -DANDROID_SMP=1 -fno-strict-aliasing
 else
-    LOCAL_CFLAGS += -DANDROID_SMP=0
+    LOCAL_CFLAGS += -DANDROID_SMP=0 -fno-strict-aliasing
 endif
 
 include $(BUILD_SHARED_LIBRARY)
@@ -112,6 +112,8 @@ LOCAL_MODULE:= test-resample
 
 LOCAL_MODULE_TAGS := optional
 
+LOCAL_CFLAGS += -fno-strict-aliasing
+
 include $(BUILD_EXECUTABLE)
 
 include $(call all-makefiles-under,$(LOCAL_PATH))
diff --git a/services/audioflinger/AudioResampler.h b/services/audioflinger/AudioResampler.h
index 2b8694f..cb0259a 100644
--- a/services/audioflinger/AudioResampler.h
+++ b/services/audioflinger/AudioResampler.h
@@ -22,6 +22,10 @@
 
 #include <media/AudioBufferProvider.h>
 
+#if __cplusplus < 201103L && !defined(__GXX_EXPERIMENTAL_CXX0X__) && !defined(constexpr)
+#define constexpr const
+#endif
+
 namespace android {
 // ----------------------------------------------------------------------------
 
@@ -66,13 +70,13 @@ class AudioResampler {
 
 protected:
     // number of bits for phase fraction - 30 bits allows nearly 2x downsampling
-    static const int kNumPhaseBits = 30;
+    static constexpr int kNumPhaseBits = 30;
 
     // phase mask for fraction
-    static const uint32_t kPhaseMask = (1LU<<kNumPhaseBits)-1;
+    static constexpr uint32_t kPhaseMask = (1LU<<kNumPhaseBits)-1;
 
     // multiplier to calculate fixed point phase increment
-    static const double kPhaseMultiplier = 1L << kNumPhaseBits;
+    static constexpr double kPhaseMultiplier = 1L << kNumPhaseBits;
 
     AudioResampler(int bitDepth, int inChannelCount, int32_t sampleRate, src_quality quality);
 
diff --git a/services/camera/libcameraservice/Android.mk b/services/camera/libcameraservice/Android.mk
index 83d9ccd..b5d503e 100644
--- a/services/camera/libcameraservice/Android.mk
+++ b/services/camera/libcameraservice/Android.mk
@@ -52,7 +52,15 @@ LOCAL_C_INCLUDES += \
     external/jpeg
 
 
-LOCAL_CFLAGS += -Wall -Wextra
+LOCAL_CFLAGS += -Wall -Wextra -fno-strict-aliasing
+
+ifeq ($(BOARD_USES_QCOM_LEGACY_CAM_PARAMS),true)
+    LOCAL_CFLAGS += -DQCOM_LEGACY_CAM_PARAMS -fno-strict-aliasing
+endif
+
+ifeq ($(BOARD_HAVE_HTC_FFC),true)
+    LOCAL_CFLAGS += -DBOARD_HAVE_HTC_FFC -fno-strict-aliasing
+endif
 
 LOCAL_MODULE:= libcameraservice
 
diff --git a/services/medialog/Android.mk b/services/medialog/Android.mk
index 08006c8..b0f0c8c 100644
--- a/services/medialog/Android.mk
+++ b/services/medialog/Android.mk
@@ -8,4 +8,6 @@ LOCAL_SHARED_LIBRARIES := libmedia libbinder libutils liblog libnbaio
 
 LOCAL_MODULE:= libmedialogservice
 
+LOCAL_CFLAGS += -fno-strict-aliasing
+
 include $(BUILD_SHARED_LIBRARY)
diff --git a/tools/resampler_tools/Android.mk b/tools/resampler_tools/Android.mk
index e8cbe39..39fcefc 100644
--- a/tools/resampler_tools/Android.mk
+++ b/tools/resampler_tools/Android.mk
@@ -14,4 +14,4 @@ LOCAL_MODULE := fir
 
 include $(BUILD_HOST_EXECUTABLE)
 
-
+LOCAL_CFLAGS += -fno-strict-aliasing
-- 
1.8.1.6

